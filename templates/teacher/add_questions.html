{% extends 'base.html' %}
{% block title %}Add Questions - {{ quiz.title }}{% endblock %}
{% block extra_head %}

{% endblock %}
{% block content %}

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['\\(','\\)'], ['$','$']]}
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_HTML"></script>
<style>
.question-text table, .option-text table {
    border-collapse: collapse;
    width: 100%;
    margin: 10px 0;
}
.question-text table td, .question-text table th,
.option-text table td, .option-text table th {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
.question-text table th, .option-text table th {
    background-color: #f3f4f6;
    font-weight: 600;
}
</style>

<div class="max-w-4xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Add Question Form -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Add Question to: {{ quiz.title }}</h2>
                <a href="{% url 'question_bank' %}?quiz_id={{ quiz.id }}" class="bg-purple-600 text-white px-3 py-1 rounded text-sm">
                    ðŸ“š Question Bank
                </a>
            </div>

            <form method="post" class="space-y-4">
                {% csrf_token %}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Question Type</label>
                    <select name="question_type" id="question_type" class="w-full px-3 py-2 border rounded" onchange="toggleQuestionType()">
                        <option value="objective">Objective (Single Choice)</option>
                        <option value="multichoice">Multi-Choice (Multiple Answers)</option>
                        <option value="theory">Theory (Essay)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Question</label>
                    {{ form.question_text }}
                </div>

                <div id="objective-options" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Option A</label>
                        {{ form.option_a }}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Option B</label>
                        {{ form.option_b }}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Option C</label>
                        {{ form.option_c }}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Option D</label>
                        {{ form.option_d }}
                    </div>

                    <div id="single-answer">
                        <label class="block text-sm font-medium text-gray-700">Correct Answer</label>
                        {{ form.correct_answer }}
                    </div>
                    <div id="multi-answer" style="display:none;">
                        <label class="block text-sm font-medium text-gray-700">Correct Answers (Select all that apply)</label>
                        <div class="space-y-2">
                            <label class="flex items-center"><input type="checkbox" name="correct_multi" value="A" class="mr-2"> A</label>
                            <label class="flex items-center"><input type="checkbox" name="correct_multi" value="B" class="mr-2"> B</label>
                            <label class="flex items-center"><input type="checkbox" name="correct_multi" value="C" class="mr-2"> C</label>
                            <label class="flex items-center"><input type="checkbox" name="correct_multi" value="D" class="mr-2"> D</label>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Marks</label>
                    <input type="number" name="max_marks" value="1" min="1" class="w-full px-3 py-2 border rounded">
                </div>

                <div class="flex justify-between">
                    <a href="{% url 'quiz_management' %}" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        Finish
                    </a>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Add Question
                    </button>
                </div>
            </form>
        </div>

        <!-- Questions List -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Questions Added ({{ questions.count }})</h3>
            
            {% if questions %}
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    {% for question in questions %}
                    <div class="border border-gray-200 rounded p-3 question-item">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-medium text-gray-900 flex-1">{{ forloop.counter }}. <span class="question-text">{{ question.question_text|safe }}</span></div>
                            <div class="flex space-x-2">
                                <a href="{% url 'edit_question' question.id %}" class="text-blue-600 hover:text-blue-800 text-sm">Edit</a>
                                <button onclick="deleteQuestion({{ question.id }})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                            </div>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ question.question_type|title }}</span>
                        {% if question.question_type == 'theory' %}
                        <p class="text-sm text-gray-600 italic mt-2">Essay Question - {{ question.max_marks }} marks</p>
                        {% else %}
                        <div class="text-sm text-gray-600 space-y-1 mt-2">
                            <div class="option-text">A) {{ question.option_a|safe }}</div>
                            <div class="option-text">B) {{ question.option_b|safe }}</div>
                            <div class="option-text">C) {{ question.option_c|safe }}</div>
                            <div class="option-text">D) {{ question.option_d|safe }}</div>
                            <p class="font-medium text-green-600 mt-2">Correct: {{ question.correct_answer }} | {{ question.max_marks }} mark(s)</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">No questions added yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{{ form.media }}
<script>
if (typeof MathJax !== 'undefined') {
    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
}

function toggleQuestionType() {
    const type = document.getElementById('question_type').value;
    const options = document.getElementById('objective-options');
    const singleAnswer = document.getElementById('single-answer');
    const multiAnswer = document.getElementById('multi-answer');
    
    if (type === 'theory') {
        options.style.display = 'none';
    } else {
        options.style.display = 'block';
        if (type === 'multichoice') {
            singleAnswer.style.display = 'none';
            multiAnswer.style.display = 'block';
        } else {
            singleAnswer.style.display = 'block';
            multiAnswer.style.display = 'none';
        }
    }
}

function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question?')) {
        fetch(`/api/delete-question/${questionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting question');
            }
        });
    }
}
</script>
{% endblock %}